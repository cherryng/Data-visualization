import matplotlib as mpl
import numpy as np
import pylab as plt
import ephem

plt.rcParams.update({'font.size':14})
plt.figure(figsize=[10,5])
ax = plt.axes(projection="hammer")

#setup axes and tick labels
plt.text(0.5,-0.05,r"$l$",
         fontsize=16,
         verticalalignment="top",
         horizontalalignment="center",
         transform=ax.transAxes,
         alpha=1,weight='bold' )
plt.ylabel(r"$b$",fontsize=16,rotation=0,
           alpha=1)
locs,labs = plt.xticks()
labs = [r"$%s^{\circ}$"%(-1*ii) for ii in range(-150,210,30)]
plt.xticks(locs,labs)
locs,labs = plt.yticks()
labs = [r"$%s^{\circ}$"%(ii) for ii in range(-75,90,15)]
plt.yticks(locs,labs)
plt.grid()

#transform 0-360 gal to -pi to pi
def trans(val):
    if val<180:
        return -1*np.pi*val/180.
    else:
        return (360-val)*np.pi/180.

def transrad(val):
    print val
    if val > np.pi:
        return -1*(2*np.pi-val)
    else:
        return val

def declimits(upper,lower):
    ra = np.linspace(0,2*np.pi,360)
    upperverts =[(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i,np.pi*upper/180.)) for i in ra]]
    lowerverts =[(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i,np.pi*lower/180.)) for i in ra]]
    return upperverts,lowerverts
    

def shade(xy,**kwargs):
    verts = [(xy[0],xy[1]),
             (xy[2],xy[1]),
             (xy[2],xy[3]),
             (xy[0],xy[3]),]
    ax.add_patch(plt.Polygon(verts,**kwargs))

def drawlimits(upper,lower,**kwargs):
    u,l = declimits(upper,lower)
    #x = np.array(u)
    #plt.plot(-x[:,0],x[:,1],**kwargs)
    x = np.array(l)
    nx = np.array([transrad(i) for i in x[:,0]])
    am = nx.argmin()
    nx = np.roll(nx,-am)
    ny = np.roll(x[:,1],-am)
    verts = []
    #verts.append((-2*np.pi,-np.pi/2))
    #verts.append((-2*np.pi,0))
    #verts.append((2*np.pi,np.pi/2))
    #verts.append((2*np.pi,0))
    #verts.append((-nx[0],-np.pi/2))
    #verts.append((np.pi*-6,2*np.pi))
    #verts.append((np.pi*6,2*np.pi))
    #verts.append((np.pi*6,-2*np.pi))
    myzip = zip(-nx,ny)
    [verts.append(z) for z in myzip]
    ax.add_patch(plt.Polygon(verts,**kwargs))
    #plt.plot(-nx,ny,**kwargs)
    nverts = [(i,-np.pi*(90-12)/180.) for i in np.linspace(-2*np.pi,2*np.pi,360)]
    [nverts.append((i,-np.pi/1.99)) for i in np.linspace(2*np.pi,-2*np.pi,360)]
    ax.add_patch(plt.Polygon(nverts,color="red"))

def add_knowns():
    x = np.genfromtxt("coords2.txt").transpose()
    x[0] = np.array([trans(i) for i in x[0]])
    x[1]*=(np.pi/180.)
    plt.scatter(x[0],x[1],s=10,marker="x",c="Orange",zorder=1000,edgecolor="OrangeRed",alpha=0.7, label="Previously known pulsars")

def add_htru():
    htru = [("03:25:00","52:39:00"),
            ("04:25:00","49:36:00"),
            ("19:13:00","37:33:00"),
            ("19:59:00","36:18:00"),
            ("20:04:00","34:27:00"),
            ("20:05:00","35:49:00"),
            ("20:36:00","28:34:00"),
            ("22:06:00","61:52:00"),
            ("22:15:00","53:26:00"),
            ("22:16:00","58:00:00"),
            ("23:20:00","64:15:00"),
            ("23:34:00","61:52:00")]
    msp = [("19:46:00","34:14:00"),
           ("17:45:00","10:17:00"),
           ("20:45:02","36:33:01"),
           ("20:53:52","46:50:51")]

    htrus =[("10:02:17.25","-59:20:13.8"),
            ("11:52:21.37","-61:10:22.4"),
            ("12:27:13.13","-63:09:53.5"),
            ("12:44:29.80","-64:02:38.7"),
            ("12:48:15.87","-64:43:20.7"),
            ("12:55:21.24","-62:48:40.6"),
            ("13:49:18.45","-63:56:24.4"),
            ("15:25:21.93","-55:23:19.1"),
            ("15:28:24.61","-55:44:16.7"),
            ("15:32:22.27","-56:07:01.9"),
            ("15:38:34.41","-56:21:01.6"),
            ("16:12:57.05","-49:27:19.9"),
            ("16:16:28.90","-50:16:01.3"),
            ("16:21:46.91","-48:48:02.9"),
            ("16:33:28.14","-49:53:25.8"),
            ("16:38:08.26","-44:43:37.9"),
            ("16:49:18.84","-39:33:22.6"),
            ("16:58:51.77","-47:10:37.5"),
            ("17:08:55.11","-36:42:31.5"),
            ("17:11:25.58","-37:23:43.7"),
            ("17:20:54.38","-36:53:15.1"),
            ("17:22:56.94","-38:23:33.9"),
            ("17:31:00.38","-33:25:27.6"),
            ("17:32:27.54","-35:09:38.4"),
            ("17:34:48.65","-31:01:30.4"),
            ("17:38:19.41","-27:35:32.9"),
            ("17:41:53.70","-34:19:38.7"),
            ("17:45:57.33","-27:58:20.6"),
            ("17:50:10.72","-28:45:36.5"),
            ("17:55:14.42","-26:03:53.7"),
            ("17:59:24.39","-24:02:44.3"),
            ("18:11:39.28","-17:18:32.6"),
            ("18:24:53.99","-13:52:28.3"),
            ("18:25:08.19","-11:11:33.8"),
            ("18:29:07.17","-10:11:09.7"),
            ("18:30:08.32","-10:39:36.1"),
            ("18:33:05.39","-02:10:36.9"),
            ("18:34:34.67","-09:11:53.9"),
            ("18:35:22.92","-09:27:34.1"),
            ("18:35:30.120","-09:21:11.000"),
            ("18:36:19.03","-11:15:10.3"),
            ("18:38:56.65","-01:05:14.8"),
            ("18:40:00.92","-02:23:26.9"),
            ("18:40:29.68","-03:33:38.7"),
            ("18:42:52.56","-07:59:22.3"),
            ("18:43:25.09","-05:09:55.9"),
            ("18:43:53.76","-03:06:15.3"),
            ("18:47:22.2","-04:29:44.5"),
            ("19:18:06.5","-65:53:01.4"),
            ("20:49:51.1","-55:01:56.6"),
            ("20:55:14.89","-67:13:52.6"),
            ("06:20:40.1","-58:57:42.7"),
            ("09:51:24.620","-71:19:01.100"),
            ("14:00:04","-40:41:45"),
            ("15:19:01.78","-39:52:03.7"),
            ("12:01:04.02","-45:47:46.2"),
            ("18:35:47.29","-08:46:25.6"),
            ("18:24:53.61","-01:33:20.3"),
            ("19:03:13.04","-08:48:37.3"),
            ("19:33:46.43","-57:06:52.9"),
            ("16:29:07.99","-38:26:31.2"),
            ("08:07:56.04","-54:20:31.7"),
            ("08:36:18.61","-42:33:16.6"),
            ("09:05:03.86","-60:15:51.8"),
            ("09:19:44.77","-60:42:31.6"),
            ("09:49:30.46","-69:02:09.5"),
            ("10:36:19.72","-65:58:26.3"),
            ("10:54:06","-59:44:05"),
            ("11:05:23.6","-43:57:01.0"),
            ("11:32:14.509","-47:00:35.9"),
            ("11:43:05.43","-55:35:09.8"),
            ("12:27:00.4409115","-62:08:43.78848"),
            ("12:37:36","-67:27:40"),
            ("12:52:11.15","-74:08:51.1"),
            ("14:09:00","-69:54:36"),
            ("13:30:55.56","-52:46:08.3"),
            ("13:46:28.14","-49:17:00.1"),
            ("14:17:31.06","-50:36:15.8"),
            ("14:32:59.8","-50:32:29"),
            ("14:43:17","-51:25:47"),
            ("15:17:24.85","-46:36:31.2"),
            ("15:30:52.04","-63:43:32.5"),
            ("15:34:47.56","-44:29:12.5"),
            ("15:39:42","-48:29:04.0"),
            ("15:52:01.52","-44:27:10.0"),
            ("15:51:29.41","-62:14:31.4"),
            ("16:08:14.8","-64:49:32.0"),
            ("16:12:27.3","-58:05:55"),
            ("16:14:53.160","-38:46:02.900"),
            ("16:22:05.26","-37:47:07.7"),
            ("16:22:44.8","-49:50:54.4"),
            ("16:25:16.1","-49:14:35"),
            ("16:25:54.8","-66:20:59.3"),
            ("16:27:48.37","-59:37:33.4"),
            ("16:29:45","-36:35:51"),
            ("16:34:05.54","-56:32:15.4"),
            ("16:36:15.22","-26:15:04.3"),
            ("16:38:30.5","-42:33:56.4"),
            ("16:47:49","-36:05:00"),
            ("16:49:10.15","-60:45:04.7"),
            ("17:00:52","-44:19:00"),
            ("17:03:59.760","-52:43:19.600"),
            ("17:04:37.33","-52:36:11.2"),
            ("17:05:06","-61:37:55.0"),
            ("17:05:41.0","-43:35:19.3"),
            ("17:09:40.28","-44:01:16.4"),
            ("17:10:01.09","-26:18:06.2"),
            ("17:08:55.55","-66:22:17.2"),
            ("17:15:53.80","-47:09:53.5"),
            ("17:19:32.67","-23:32:00.2"),
            ("17:29:10.8","-21:17:26"),
            ("17:20:16.72","-24:46:54.2"),
            ("17:33:43.2","-55:16:49.7"),
            ("17:45:26.57","-38:12:23.8"),
            ("17:44:36.60","-53:40:23.8"),
            ("17:47:54.76","-10:28:55.6"),
            ("17:49:45.72","-54:15:54.0"),
            ("17:49:42.960","-49:28:46.500"),
            ("17:54:34.39","-24:19:26.4"),
            ("17:55:06.15","-09:02:36.6"),
            ("17:57:07.77","-15:00:54.7"),
            ("17:59:34.67","-10:28:29.7"),
            ("18:02:15.53","-05:25:33.6"),
            ("18:02:50.01","-33:47:41.9"),
            ("18:03:44.3","-33:29:04"),
            ("18:05:39.85","-29:49:51.0"),
            ("18:09:56.0","-01:20:07"),
            ("18:11:22.9","-49:28:43"),
            ("18:12:40.9","-27:46:55"),
            ("18:14:05.0","-05:28:17.1"),
            ("18:17:06.67","-19:40:56.0"),
            ("18:18:15.11","-01:49:02.1"),
            ("18:26:09.49","-31:03:33.9"),
            ("18:37:43.320","-08:20:04.100"),
            ("18:40:49.080","-04:38:27.300"),
            ("18:46:42.03","-42:43:52.7"),
            ("18:54:53.5","-15:57:48"),
            ("18:55:21.720","-16:21:25.600"),
            ("18:12:46.69","-30:39:21.5"),
            ("19:00:14","-09:28:08.5"),
            ("19:02:44.92","-10:37:10.9"),
            ("19:04:45.840","-16:24:47.100"),
            ("19:07:03.34","-15:32:51.0"),
            ("19:20:49.200","-09:46:27.000"),
            ("20:06:37.84","-13:12:59.0"),
            ("09:12:52.56","-38:49:59.9"),
            ("23:59:15.42","-65:40:31.6"),
            ("10:02:17.25","-59:20:13.8"),
            ("11:01:37.1701915","-64:24:39.72147"),
            ("11:52:21.37","-61:10:22.4"),
            ("12:27:12.64","-63:09:42.5"),
            ("12:44:47.6305212","-63:59:48.04054"),
            ("12:48:15.87","-64:43:20.7"),
            ("12:55:21.24","-62:48:40.6"),
            ("13:49:17.55","-63:58:29.9"),
            ("15:00:11.88","-55:49:25"),
            ("15:25:21.93","-55:23:19.1"),
            ("15:28:24.61","-55:44:16.7"),
            ("15:32:22.27","-56:07:01.9"),
            ("15:38:34.41","-56:21:01.6"),
            ("15:57:22.03","-51:51:09.7"),
            ("16:12:04.63","-55:09:27.2"),
            ("16:12:57.05","-49:27:19.9"),
            ("16:16:28.90","-50:16:01.3"),
            ("16:21:46.91","-48:48:02.9"),
            ("16:27:33.12","-51:08:07.1"),
            ("16:27:46.44","-49:54:35.8"),
            ("16:33:28.14","-49:53:25.8"),
            ("16:38:08.26","-44:43:37.9"),
            ("16:49:18.84","-39:33:22.6"),
            ("16:58:51.77","-47:10:37.5"),
            ("17:08:55.11","-36:42:31.5"),
            ("17:11:25.58","-37:23:43.7"),
            ("17:18:14.4","-41:07:28.8"),
            ("17:20:42.36","-36:55:32.2"),
            ("17:22:56.94","-38:23:33.9"),
            ("17:30:04.96","-34:48:41.8"),
            ("17:31:00.38","-33:25:27.6"),
            ("17:32:27.54","-35:09:38.4"),
            ("17:34:48.65","-31:01:30.4"),
            ("17:38:19.41","-27:35:32.9"),
            ("17:41:53.70","-34:19:38.7"),
            ("17:43:06.96","-35:32:19.6"),
            ("17:45:57.33","-27:58:20.6"),
            ("17:48:12.10","-30:16:25.8"),
            ("17:50:10.72","-28:45:36.5"),
            ("17:55:14.42","-26:03:53.7"),
            ("17:55:39.36","-25:53:10.6"),
            ("17:56:44.52","-25:28:03.7"),
            ("17:58:07.65","-27:43:19.4"),
            ("17:59:24.39","-24:02:44.3"),
            ("18:11:39.28","-17:18:32.6"),
            ("18:19:37.97","-17:04:57.8"),
            ("18:24:53.99","-13:52:28.3"),
            ("18:25:08.19","-11:11:33.8"),
            ("18:29:07.17","-10:11:09.7"),
            ("18:30:08.32","-10:39:36.1"),
            ("18:33:05.39","-02:10:36.9"),
            ("18:34:34.67","-09:11:53.9"),
            ("18:35:22.92","-09:27:34.1"),
            ("18:35:30.120","-09:21:11.000"),
            ("18:36:19.03","-11:15:10.3"),
            ("18:38:56.65","-01:05:14.8"),
            ("18:40:00.92","-02:23:26.9"),
            ("18:40:29.68","-03:33:38.7"),
            ("18:42:52.56","-07:59:22.3"),
            ("18:43:25.09","-05:09:55.9"),
            ("18:43:53.76","-03:06:15.3"),
            ("18:47:22.2","-04:29:44.5")]



    htrusmsp =[("18:04:01.5235171","-28:58:46.57645"),
               ("17:54:00.00","+00:36:00.00"),
               ("10:17:51.3284542","-71:56:41.64059"),
               ("10:56:45.9952928","-71:17:53.39162"),
               ("11:25:44.3652242","-58:25:16.86491"),
               ("14:05:51.4257825","-46:56:02.27825"),
               ("13:37:31.8823354","-64:23:04.93695"),
               ("14:31:44.6172157","-47:15:27.57485"),
               ("14:31:03.4960182","-57:40:11.65432"),
               ("14:46:35.7139624","-47:01:26.76652"),
               ("15:02:18.636","-67:52:16.85"),
               ("15:25:28.1339809","-55:45:49.84230"),
               ("15:29:15.1066678","-38:28:45.85300"),
               ("15:43:44.144","-51:49:54.87"),
               ("15:45:55.9561879","-45:50:37.46705"),
               ("16:22:03.666","-66:17:16.99"),
               ("16:53:30.62","-20:53:38.5"),
               ("17:05:43.8517055","-19:03:40.87865"),
               ("17:08:17.6232911","-35:06:22.69515"),
               ("17:19:10.0729329","-14:38:00.94230"),
               ("17:31:17.6086","-18:47:33.5389"),
               ("17:55:26.04","-37:15:39.5"),
               ("18:01:25.8900837","-32:10:53.58277"),
               ("18:11:19.8551486","-24:05:19.84105"),
               ("18:25:55.50","-03:22:57.4"),
               ("18:26:35.79","-24:15:10.82"),
               ("18:32:27.59442","-08:36:54.969"),
               ("22:36:51.8582574","-55:27:48.84403"),
               ("23:22:34.6303517","-26:50:57.98051"),
               ("20:03:51.1","-09:34:39"),
               ("17:58:07.65","-27:43:19.4"),
               ("11:01:37.1701915","-64:24:39.72147")]
    frb=[("22:34:38","-12:24:44"),
         ("21:03:43","-44:44:19"),
         ("23:30:51","-02:52:24"),
#         ("18:14:47.35","-85:11:53.13"),
         ("23:15:06","-18:25:38")]

    
    pos =np.array([(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i[0],i[1])) for i in htru]]).transpose()
    nx = np.array([transrad(i) for i in pos[0]])
    plt.scatter(-nx,pos[1],marker="s",s=45,color="y",edgecolor="k",zorder=2000,label="HTRU-North")

    pos =np.array([(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i[0],i[1])) for i in msp]]).transpose()
    nx = np.array([transrad(i) for i in pos[0]])
    plt.scatter(-nx,pos[1],marker="s",s=45,color="black",edgecolor="k",zorder=2100,label="HTRU-North MSPs")

    pos =np.array([(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i[0],i[1])) for i in htrus]]).transpose()
    nx = np.array([transrad(i) for i in pos[0]])
    plt.scatter(-nx,pos[1],marker=".",s=150,color="red",edgecolor="k",zorder=2000, label="HTRU-South")

    pos =np.array([(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i[0],i[1])) for i in htrusmsp]]).transpose()
    nx = np.array([transrad(i) for i in pos[0]])
    plt.scatter(-nx,pos[1],marker=".",s=150,color="black",edgecolor="k",zorder=2100, label="HTRU-South MSPs")

    pos =np.array([(j.lon,j.lat) for j in [ephem.Galactic(ephem.Equatorial(i[0],i[1])) for i in frb]]).transpose()
    nx = np.array([transrad(i) for i in pos[0]])
    plt.scatter(-nx,pos[1],marker="*",s=150,color="red",edgecolor="k",zorder=2000, label="FRBs")


def eff():
    #drawlimits(90,-20,color="red",hatch="\\")
    add_knowns()
    add_htru()


if __name__ == "__main__":
    eff()


#    plt.legend(loc='upper right', scatterpoints = 1, prop={'size':11} )
    plt.legend(bbox_to_anchor=(1.105,1.08),  scatterpoints = 1, prop={'size':12})
    plt.figtext(0.3, 0.95, "HTRU discoveries (as of January 2015)")
#    plt.figtext(0.78, 0.15, "Image credit: Cherry Ng",fontsize=11)
    
#    plt.savefig("HTRU-discoveries-sky-2000x1000.png",transparent=True,bbox_inches='tight')
    plt.show()
